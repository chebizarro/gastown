services:
  deacon:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${GT_VERSION:-dev}
        COMMIT: ${GT_COMMIT:-unknown}
        BUILD_TIME: ${GT_BUILD_TIME:-1970-01-01T00:00:00Z}
    image: gastown:local
    command: ["daemon", "run"]
    environment:
      GT_RIG: ${GT_RIG:-gastown}

      # Rig-rooted town root (as required)
      GT_TOWN_ROOT: /gt/${GT_RIG}
      GT_ROOT: /gt/${GT_RIG}

      # Nostr support
      GT_NOSTR_ENABLED: "1"
      GT_NOSTR_CONFIG: /gt/${GT_RIG}/settings/nostr.json

      # Optional migration/sunset flags (defaults preserve local behavior)
      GT_EVENTS_LOCAL: ${GT_EVENTS_LOCAL:-1}
      GT_FEED_CURATOR: ${GT_FEED_CURATOR:-1}
      GT_CONVOY_LOCAL: ${GT_CONVOY_LOCAL:-1}
    working_dir: /gt/${GT_RIG:-gastown}
    volumes:
      - ./rigs/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}
      - ./runtime/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}/.runtime
    restart: unless-stopped

  agentloop:
    image: gastown:local
    depends_on: [deacon]
    # Requires internal/cmd/agentloop.go (added in this change)
    command:
      - "agentloop"
      - "run"
      - "--rig"
      - "${GT_RIG:-gastown}"
      - "--role"
      - "${GT_AGENT_ROLE:-witness}"
      - "--instance"
      - "${GT_AGENT_INSTANCE:-agent1}"
      - "--agents-config"
      - "/gt/${GT_RIG:-gastown}/settings/agents.json"
      - "--agent"
      - "${GT_AGENT_ID:-claude-api}"
      - "--workdir"
      - "/gt/${GT_RIG:-gastown}"
      # Optional: seed an initial task so the container does work immediately
      # - "--task"
      # - "${GT_AGENT_TASK:-}"
      # Optional: poll for work via `gt prime` and auto-assign work
      # - "--prime-interval"
      # - "${GT_AGENT_PRIME_INTERVAL:-30s}"
    environment:
      GT_RIG: ${GT_RIG:-gastown}
      GT_TOWN_ROOT: /gt/${GT_RIG}
      GT_ROOT: /gt/${GT_RIG}

      GT_NOSTR_ENABLED: "1"
      GT_NOSTR_CONFIG: /gt/${GT_RIG}/settings/nostr.json

      # LLM creds referenced via agents.json (api.api_key: "$OPENAI_API_KEY" etc.)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    working_dir: /gt/${GT_RIG:-gastown}
    volumes:
      - ./rigs/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}
      - ./runtime/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}/.runtime
    restart: unless-stopped

  mcp:
    image: gastown:local
    depends_on: [deacon]
    # Requires internal/cmd/mcp.go (added in this change)
    command:
      - "mcp"
      - "serve"
      - "--addr"
      - "0.0.0.0:9500"
      - "--rig"
      - "${GT_RIG:-gastown}"
      - "--workdir"
      - "/gt/${GT_RIG:-gastown}"
      - "--auth-token"
      - "${GT_MCP_TOKEN}"
    environment:
      GT_RIG: ${GT_RIG:-gastown}
      GT_TOWN_ROOT: /gt/${GT_RIG}
      GT_ROOT: /gt/${GT_RIG}

      GT_NOSTR_ENABLED: "1"
      GT_NOSTR_CONFIG: /gt/${GT_RIG}/settings/nostr.json
    working_dir: /gt/${GT_RIG:-gastown}
    ports:
      - "9500:9500"
    volumes:
      - ./rigs/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}
      - ./runtime/${GT_RIG:-gastown}:/gt/${GT_RIG:-gastown}/.runtime
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9500/mcp/health"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped
